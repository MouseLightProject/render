#!/bin/bash

# usage: ./render <copy_of_parameters.jl>

# git-pull will complain if parameters.jl is modified

# to monitor progress:
#   watch -n 120 tail -n 40 <destination>/monitor.log

# data are temporarily logged in <logfile_scratch>/{director,monitor,squatter1-N,merge1-130}.log,
# where N=throttle_leaf from parameters.jl, and then tar'd into <destination>/logs.tar.gz.
# manual queries into these log files are informative:
#   tar xzfO <destination>/logs.tar.gz render.log 
#   tar xzfO <destination>/logs.tar.gz | grep "ERROR"
#   tar xzfO <destination>/logs.tar.gz | grep "reading input tile" | wc

# also put in <destination> are
#   set_parameters.jl: a copy of <parameters.jl> specified on the command line
#   calculated_parameters.jl
#   tilebase.cache.yml
#   transform.txt
#   render.log

set -e

export RENDER_PATH=/home/arthurb/projects/mouselight
export JULIA=/groups/mousebrainmicro/mousebrainmicro/Software/barycentric2/julia-0.4.6/bin/julia

# get vars from parameters.jl file
read -a tmp <<< $($JULIA -L $1 -e "print(destination,' ',shared_scratch,' ',logfile_scratch,' ',delete_scratch,' ',notify_addr,' ',bill_userid,' ',typeof(which_cluster) <: ASCIIString ? which_cluster : join(which_cluster, ','),' ',throttle_octree)")
destination=${tmp[0]}
shared_scratch=${tmp[1]}
logfile_scratch=${tmp[2]}
delete_scratch=${tmp[3]}
notify_addr=${tmp[4]}
bill_userid=${tmp[5]}
which_cluster=${tmp[6]}
throttle_octree=${tmp[7]}

# delete <logfile_scratch> and <destination> if they exist
if [ -d $logfile_scratch ] ; then
  echo "deleting logfile_scratch = $logfile_scratch"  >> $logfile_scratch/render.log
  rm -rf $logfile_scratch
fi
mkdir -p $logfile_scratch
if [ -d $destination ] ; then
  echo "deleting destination = $destination" >> $logfile_scratch/render.log
  rm -rf $destination
fi
mkdir -p $destination

date >> $logfile_scratch/render.log
hostname >> $logfile_scratch/render.log

# copy parameters to <destination>
cp $1 $destination/set_parameters.jl

# create a probably-unique job name
jobname=$(cat /dev/urandom | tr -dc 'a-zA-Z' | head -c 7)
echo jobname = $jobname >> $logfile_scratch/render.log

# create the leaf nodes
cmd="$JULIA ${RENDER_PATH}/src/render/director.jl $destination/set_parameters.jl $jobname"
echo $cmd &>> $logfile_scratch/render.log
if [ $which_cluster == 'janelia' ]; then
  qsub -A $bill_userid -N $jobname -j y -b y -V -shell n -l sandy=true -o $logfile_scratch/director.log $cmd
else
  eval $cmd &> $logfile_scratch/director.log
fi

# downsample the octree
expr="include(\"${destination}/set_parameters.jl\");
      include(\"${destination}/calculated_parameters.jl\");
      t=time();
      id=parse(Int,ENV[\"SGE_TASK_ID\"]);
      ch=(id-1)%2+1;
      oct=(id-1)>>4+1;
      oct2=((id-1)>>1)%8+1;
      tmp=joinpath(shared_scratch,string(oct),string(oct2));
      if isdir(tmp) 
        merge_output_tiles(shared_scratch, destination, \"default\", \".\"*string(ch-1)*\".tif\",
              string(oct)*\"/\"*string(oct2), true, true, false);
        info(\"merging took \",string(round(Int,time()-t)),\" sec\");
        if delete_scratch==\"as-you-go\"
          info(\"deleting shared_scratch = \",tmp);
          run(\`find \$tmp -name *.\$(string(ch-1)).tif -delete\`);
        end;
      end"
cmd="date;
     hostname;
     $JULIA -L ${RENDER_PATH}/src/render/admin.jl -e '$expr';
     date;"
echo $cmd &>> $logfile_scratch/render.log
if [ $which_cluster == 'janelia' ]; then
  echo $cmd | qsub -A $bill_userid -N ${jobname}2 -t 1:128 -tc $throttle_octree -pe batch 9 -j y -b n -V \
        -hold_jid $jobname -l sandy=true -o $logfile_scratch/merge'$TASK_ID'.log
else
  pcmd="export RENDER_PATH=$RENDER_PATH; export LD_LIBRARY_PATH=$LD_LIBRARY_PATH; export JULIA=$JULIA; export SGE_TASK_ID={}; { $cmd } &> $logfile_scratch/merge{}.log"
  parallel -S $which_cluster -j $throttle_octree $pcmd ::: `seq 1 128` &>> $logfile_scratch/render.log
fi

expr="include(\"${destination}/set_parameters.jl\");
      include(\"${destination}/calculated_parameters.jl\");
      t=time();
      id=parse(Int,ENV[\"SGE_TASK_ID\"]);
      ch=(id-129)%2+1;
      merge_output_tiles(nlevels>1 ? destination : shared_scratch, destination, \"default\",
            \".\"*string(ch-1)*\".tif\", \"\", true, true, false);
      info(\"merging took \",string(round(Int,time()-t)),\" sec\")"
cmd="date;
     hostname;
     $JULIA -L ${RENDER_PATH}/src/render/admin.jl -e '$expr';
     date;"
echo $cmd &>> $logfile_scratch/render.log
if [ $which_cluster == 'janelia' ]; then
  echo $cmd | qsub -A $bill_userid -N ${jobname}3 -t 129:130 -pe batch 9 -j y -b n -V \
        -hold_jid ${jobname}2 -l sandy=true -o $logfile_scratch/merge'$TASK_ID'.log
else
  pcmd="export RENDER_PATH=$RENDER_PATH; export LD_LIBRARY_PATH=$LD_LIBRARY_PATH; export JULIA=$JULIA; export SGE_TASK_ID={}; { $cmd } &> $logfile_scratch/merge{}.log"
  parallel -S $which_cluster -j $throttle_octree $pcmd ::: `seq 129 130` &>> $logfile_scratch/render.log
fi

# delete shared_scratch
cmd="date;
     hostname;
     df -h $shared_scratch;
     echo deleting shared_scratch = $shared_scratch;
     rm -rf $shared_scratch;
     echo ./savelogs $destination | mail -s \"job $jobname finished\" $notify_addr;
     date"
echo $cmd &>> $logfile_scratch/render.log
if [ $which_cluster == 'janelia' ]; then
  echo $cmd | qsub -A $bill_userid -N ${jobname}4 -j y -b n -V \
        -hold_jid ${jobname}3 -l sandy=true \
        -o $logfile_scratch/render.log -m e -M $notify_addr
else
  eval $cmd &>> $logfile_scratch/render.log
fi

# email user
echo watch -n 60 tail -n '$((LINES-2))' $logfile_scratch/monitor.log | mail -s "job $jobname started" $notify_addr

# start the monitor process
nohup sh -c "sleep 10; ${RENDER_PATH}/src/render/monitor $jobname $destination/set_parameters.jl &> ${logfile_scratch}/monitor.log" 2>/dev/null &

date >> $logfile_scratch/render.log
